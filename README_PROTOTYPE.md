I have made some progress on improving bat startup time through some prototyping work, and I would like to share that prototype here. I would love to get some feedback on it. Especially critisism!

First, allow me to present some performance numbers from my (low-end) machine:

| File under ./tests/syntax-tests/source | bat master    | my prototype |
| -------------------------------------- | ------------- | ------------- |
| example.zig                            | 108.5 ms      | 25.8 ms       |
| example.xml                            | 102.1 ms      | 45.1 ms       |
| example.md                             | 123.1 ms      | 57.5 ms       |
|                                        

| Content Cell  | Content Cell  |
| Content Cell  | Content Cell  |

| bat master    | bat prototype |
| ------------- | ------------- |
| Content Cell  | Content Cell  |
| Content Cell  | Content Cell  |


One major limitation of the prototype is that I only made it work for
`--language`, and not for file extension or first-line. So for example, I use this command to benchmark `.xml`:

    hyperfine 'bat --no-config --pager=never --color=always ./tests/syntax-tests/source/XML/example.xml --language xml'

It should be pretty straightforward to make it work for e.g. file extensions
too, but I don't want to spend time on it until I have gotten an external sanity
check on my overall approach.

We can see from the benchmark that small syntaxes such sa Zig, which only contains the Zig Syntax Definition, is pretty fast. Medium sized SyntaxSet such as XML (contains `["xml", "xsd", "xslt", "tld", "dtml", "rng", "rss", "opml", "svg"]`) is slower, and even larger ones such as Markdown is even slower. But still a nice improvement I would say!

Some notable positive properties of the prototype:
 * All non-ignored `cargo test` tests passes.
 * Most (but not all) syntax regression tests passes.

Some notable negative properties:
 * The stripped release binary size grows from 4,7M to 7,7M. Can probably be optimized quite a bit though.
 * Only syntaxes embedded in the binary works, but should be straightforward to make it work for locally built cache too. I have prepared the code a bit for that.
 * I disregard any public API stability concerns or other backwards compatibility (e.g. asset metadata)

So, how does the prototype work? Roughly like this:

* There are are two new assets. `independent_syntax_sets.bin` contains concatenated binary representations of independent syntax sets, and `independent_syntax_sets_map.bin` contains a small lookup datastructure so they can be found again.
* The new assets are generated by analyzing dependencies between SyntaxDefinitions and creating independent SyntaxSets. By loading only the necessary linked syntax definitions, startup time is greatly improved.

I could write a lot more about how it works, but time is short at the moment... But stay tuned!

My current plan forward is to take the code from the prototype and turn it into several small and independent PRs that are easy to review and understand one by one.

One day we'll get there :)





This is a prototype that experiements with one way to solve https://github.com/sharkdp/bat/issues/951.

What works:
* All regression tests pass
* Significantly faster startup speed for small syntaxes, but also improvments for large syntaxes that embemds other syntaxes


Future considerations:
* We might want to load ThemeSet cleverly too, in which case the current lookup data structure is insufficent, so would be good not to expose it publicly if possible

MVP scope:
* Only simple lookup by name and extension. Later versions can support first line match for example.

The way it works:
* We analyzes dependencies between SyntaxDefinitions and write them to file with lookup map
* TODO

syntaxes.bin is changed to contain several independent syntax sets, concatenated in binary form and looked up with an offset and size hashmap.
